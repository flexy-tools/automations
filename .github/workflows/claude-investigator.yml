name: Claude Code Error Investigation

on:
  repository_dispatch:
    types: [error_investigation]

jobs:
  investigate:
    runs-on: ubuntu-latest
    name: Investigate Error with Claude Code
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display error information
        run: |
          echo "ðŸ” BetterStack Error Investigation Triggered"
          echo "============================================="
          echo "Error ID: ${{ github.event.client_payload.error.errorId }}"
          echo "Title: ${{ github.event.client_payload.error.title }}"
          echo "Error Type: ${{ github.event.client_payload.error.errorType }}"
          echo "Message: ${{ github.event.client_payload.error.message }}"
          echo "Platform: ${{ github.event.client_payload.error.platform }}"
          echo "Environment: ${{ github.event.client_payload.error.environment }}"
          echo "Project: ${{ github.event.client_payload.error.projectName }}"
          echo "Culprit: ${{ github.event.client_payload.error.culprit }}"
          echo "Timestamp: ${{ github.event.client_payload.error.timestamp }}"
          echo "Source: ${{ github.event.client_payload.source }}"
          echo "============================================="

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f development.txt ]; then pip install -r development.txt; fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude SDK
        run: |
          npm install -g @anthropic-ai/sdk

      - name: Configure Git
        run: |
          git config --global user.name "Claude Code Bot"
          git config --global user.email "claude-code-bot@flexy-tools.com"

      - name: Create investigation branch
        run: |
          BRANCH_NAME="fix/error-${{ github.event.client_payload.error.errorId }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Claude investigation and create fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > investigate.js << 'EOFJS'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");
          const { execSync } = require("child_process");

          const anthropic = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY,
          });

          const errorContext = ${{ toJson(github.event.client_payload.error) }};

          async function investigateAndFix() {
            console.log("ðŸ” Starting Claude investigation...");

            // Extract file path from culprit
            const culpritMatch = errorContext.culprit.match(/([^\s]+\.py)/);
            const filePath = culpritMatch ? culpritMatch[1] : null;

            let fileContent = "";
            if (filePath && fs.existsSync(filePath)) {
              fileContent = fs.readFileSync(filePath, "utf-8");
              console.log(`ðŸ“„ Read file: ${filePath} (${fileContent.length} bytes)`);
            }

            const prompt = `You are investigating a production error. Analyze it and create a fix.

## Error Information
- **Error Type**: ${errorContext.errorType}
- **Message**: ${errorContext.message}
- **File**: ${errorContext.culprit}
- **Application**: ${errorContext.projectName}
- **Environment**: ${errorContext.environment}

## Stacktrace
\`\`\`
${JSON.stringify(errorContext.stacktrace, null, 2)}
\`\`\`

## File Content (${filePath || 'Not found'})
\`\`\`python
${fileContent || 'File not available'}
\`\`\`

## Task
1. Analyze the error
2. Identify the root cause
3. If this is the /sentry-debug/ test endpoint, implement proper handling to prevent false alerts in production
4. Otherwise, implement a proper fix for the bug
5. Provide the COMPLETE fixed file content

## Response Format
Provide your response in this exact format:

### Analysis
[Your analysis of the error]

### Fix Implementation
\`\`\`python
[Complete fixed file content]
\`\`\`

### Explanation
[Brief explanation of what you changed and why]`;

            const message = await anthropic.messages.create({
              model: "claude-sonnet-4-20250514",
              max_tokens: 4096,
              messages: [
                {
                  role: "user",
                  content: prompt,
                },
              ],
            });

            const response = message.content[0].text;
            console.log("ðŸ“ Claude's response:");
            console.log(response);

            // Extract the fixed code
            const codeMatch = response.match(/```python\n([\s\S]*?)\n```/);
            if (codeMatch && filePath) {
              const fixedCode = codeMatch[1];
              fs.writeFileSync(filePath, fixedCode, "utf-8");
              console.log(`âœ… Applied fix to ${filePath}`);

              // Stage the file
              execSync(`git add ${filePath}`);

              // Extract explanation for commit message
              const explanationMatch = response.match(/### Explanation\n([\s\S]*?)(?=\n###|$)/);
              const explanation = explanationMatch ? explanationMatch[1].trim() : "Fix production error";

              // Create commit
              const commitMessage = `Fix: ${errorContext.title}

${explanation}

Error ID: ${errorContext.errorId}
Error Type: ${errorContext.errorType}

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4 <noreply@anthropic.com>`;

              fs.writeFileSync("commit_message.txt", commitMessage);
              execSync("git commit -F commit_message.txt");
              console.log("âœ… Created commit");

              return { success: true, filePath, explanation };
            } else {
              console.log("âš ï¸  No code block found in response or file path not available");
              return { success: false, reason: "No fix generated" };
            }
          }

          investigateAndFix()
            .then((result) => {
              if (result.success) {
                console.log("âœ… Investigation completed successfully");
                process.exit(0);
              } else {
                console.log("âš ï¸  Investigation completed but no changes made");
                process.exit(0);
              }
            })
            .catch((error) => {
              console.error("âŒ Investigation failed:", error);
              process.exit(1);
            });
          EOFJS

          node investigate.js

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet HEAD~1; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes were made by Claude"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git show --stat
          fi

      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract commit message for PR body
          PR_BODY=$(git log -1 --pretty=%B)

          # Create the pull request
          gh pr create \
            --title "ðŸ¤– Fix: ${{ github.event.client_payload.error.title }}" \
            --body "## ðŸ¤– Automated Error Fix

This PR was automatically created by Claude in response to a production error detected by BetterStack.

### Error Details
- **Error ID**: \`${{ github.event.client_payload.error.errorId }}\`
- **Error Type**: \`${{ github.event.client_payload.error.errorType }}\`
- **Message**: ${{ github.event.client_payload.error.message }}
- **File**: \`${{ github.event.client_payload.error.culprit }}\`
- **Application**: ${{ github.event.client_payload.error.projectName }}
- **Environment**: ${{ github.event.client_payload.error.environment }}
- **Timestamp**: ${{ github.event.client_payload.error.timestamp }}

### Changes Made

$PR_BODY

### Testing
- [ ] Review the code changes
- [ ] Run tests locally: \`python manage.py test\`
- [ ] Verify the fix addresses the root cause
- [ ] Check for any side effects

---

ðŸ¤– **Automated PR created by Claude**
ðŸ“Š **BetterStack Incident**: ${{ github.event.client_payload.error.errorId }}
ðŸ”— **Source**: BetterStack Error Monitoring" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "automated,bug,claude-code" \
            --assignee "${{ github.repository_owner }}"

          echo "âœ… Pull request created successfully"

      - name: Log completion
        run: |
          echo "âœ… Error investigation workflow completed"
          echo "Error ID: ${{ github.event.client_payload.error.errorId }}"
          echo "Error Type: ${{ github.event.client_payload.error.errorType }}"
          echo "Application: ${{ github.event.client_payload.error.projectName }}"

      - name: Cleanup
        if: always()
        run: |
          rm -f investigate.js commit_message.txt
