name: Claude Code Error Investigation

on:
  repository_dispatch:
    types: [error_investigation]

jobs:
  investigate:
    runs-on: ubuntu-latest
    name: Investigate Error with Claude Code
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display error information
        run: |
          echo "üîç BetterStack Error Investigation Triggered"
          echo "============================================="
          echo "Error ID: ${{ github.event.client_payload.error.errorId }}"
          echo "Title: ${{ github.event.client_payload.error.title }}"
          echo "Error Type: ${{ github.event.client_payload.error.errorType }}"
          echo "Message: ${{ github.event.client_payload.error.message }}"
          echo "Platform: ${{ github.event.client_payload.error.platform }}"
          echo "Environment: ${{ github.event.client_payload.error.environment }}"
          echo "Project: ${{ github.event.client_payload.error.projectName }}"
          echo "Culprit: ${{ github.event.client_payload.error.culprit }}"
          echo "Timestamp: ${{ github.event.client_payload.error.timestamp }}"
          echo "Source: ${{ github.event.client_payload.source }}"
          echo "============================================="

      - name: Run Claude Code Investigation
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowed-tools "Bash,Edit,Write,Read,Glob,Grep"'
          show_full_output: true
          prompt: |
            üö® **PRODUCTION ERROR DETECTED - AUTOMATIC FIX REQUIRED**

            A production error has been detected by BetterStack monitoring. Your task is to:
            1. Analyze the error
            2. Identify the root cause
            3. Implement a fix
            4. Create a commit
            5. Push the branch
            6. Create a pull request

            ## Error Information

            - **Error ID**: ${{ github.event.client_payload.error.errorId }}
            - **Error Type**: ${{ github.event.client_payload.error.errorType }}
            - **Message**: ${{ github.event.client_payload.error.message }}
            - **File/Function**: ${{ github.event.client_payload.error.culprit }}
            - **Application**: ${{ github.event.client_payload.error.projectName }}
            - **Environment**: ${{ github.event.client_payload.error.environment }}
            - **Timestamp**: ${{ github.event.client_payload.error.timestamp }}

            ## Stacktrace

            ```json
            ${{ toJson(github.event.client_payload.error.stacktrace) }}
            ```

            ## Full Context

            ```json
            ${{ toJson(github.event.client_payload.error.context) }}
            ```

            ## Investigation Steps

            1. **Read the file** mentioned in the culprit: `${{ github.event.client_payload.error.culprit }}`

            2. **Analyze the error**:
               - Understand what caused the error
               - Check if this is the `/sentry-debug/` test endpoint
               - Determine if it's a real bug or intentional behavior

            3. **Implement the fix**:
               - If this is `/sentry-debug/` or a test endpoint, add proper error handling to prevent false alerts in production
               - If it's a real bug, implement a proper fix
               - Ensure the fix doesn't break existing functionality
               - Follow Django/Python best practices
               - Check `CLAUDE.md` for project-specific guidelines

            4. **Create a branch and commit**:
               - Create branch: `fix/error-${{ github.event.client_payload.error.errorId }}`
               - Commit message format:
                 ```
                 Fix: ${{ github.event.client_payload.error.title }}

                 [Brief explanation of the fix]

                 Error ID: ${{ github.event.client_payload.error.errorId }}
                 Error Type: ${{ github.event.client_payload.error.errorType }}

                 ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

                 Co-Authored-By: Claude Sonnet 4 <noreply@anthropic.com>
                 ```

            5. **Create a pull request**:
               - Title: `ü§ñ Fix: ${{ github.event.client_payload.error.title }}`
               - Include error details in the PR description
               - Add labels: `automated`, `bug`, `claude-code`
               - Assign to repository owner

            ## Important Notes

            - Use `gh pr create` to create the pull request
            - Use `git` commands to create branch, commit, and push
            - This is a production error - prioritize correctness and safety
            - Add appropriate error handling and logging
            - Consider edge cases and potential side effects

            ## Example git workflow

            ```bash
            git config --global user.name "Claude Code Bot"
            git config --global user.email "claude-code-bot@flexy-tools.com"
            git checkout -b fix/error-${{ github.event.client_payload.error.errorId }}

            # Make your changes...

            git add [files]
            git commit -m "Fix: [title]..."
            git push origin fix/error-${{ github.event.client_payload.error.errorId }}

            gh pr create \
              --title "ü§ñ Fix: [title]" \
              --body "[PR description]" \
              --base main \
              --head fix/error-${{ github.event.client_payload.error.errorId }} \
              --label "automated,bug,claude-code"
            ```

            Please proceed with the investigation and create the PR.
