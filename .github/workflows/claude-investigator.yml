name: Claude Code Error Investigation

on:
  repository_dispatch:
    types: [error_investigation]

jobs:
  investigate:
    runs-on: ubuntu-latest
    name: Investigate Error with Claude Code
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display error information
        run: |
          echo "ðŸ” BetterStack Error Investigation Triggered"
          echo "============================================="
          echo "Error ID: ${{ github.event.client_payload.error.errorId }}"
          echo "Title: ${{ github.event.client_payload.error.title }}"
          echo "Error Type: ${{ github.event.client_payload.error.errorType }}"
          echo "Message: ${{ github.event.client_payload.error.message }}"
          echo "Platform: ${{ github.event.client_payload.error.platform }}"
          echo "Environment: ${{ github.event.client_payload.error.environment }}"
          echo "Project: ${{ github.event.client_payload.error.projectName }}"
          echo "Culprit: ${{ github.event.client_payload.error.culprit }}"
          echo "Timestamp: ${{ github.event.client_payload.error.timestamp }}"
          echo "Source: ${{ github.event.client_payload.source }}"
          echo "============================================="

      - name: Create error context file
        run: |
          cat > error_context.json << 'EOF'
          ${{ toJson(github.event.client_payload.error) }}
          EOF
          echo "Error context file created:"
          cat error_context.json | jq '.'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f development.txt ]; then pip install -r development.txt; fi

      - name: Set up Node.js for Claude Code
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config --global user.name "Claude Code Bot"
          git config --global user.email "claude-code-bot@flexy-tools.com"

      - name: Create investigation branch
        run: |
          BRANCH_NAME="fix/error-${{ github.event.client_payload.error.errorId }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create investigation prompt
        run: |
          cat > investigation_prompt.md << 'EOF'
          # ðŸ› Automated Error Investigation

          A production error has been detected by BetterStack monitoring. Please investigate and create a fix.

          ## Error Information

          - **Error ID**: ${{ github.event.client_payload.error.errorId }}
          - **Error Type**: ${{ github.event.client_payload.error.errorType }}
          - **Title**: ${{ github.event.client_payload.error.title }}
          - **Message**: ${{ github.event.client_payload.error.message }}
          - **File/Function**: ${{ github.event.client_payload.error.culprit }}
          - **Platform**: ${{ github.event.client_payload.error.platform }}
          - **Environment**: ${{ github.event.client_payload.error.environment }}
          - **Application**: ${{ github.event.client_payload.error.projectName }}
          - **Timestamp**: ${{ github.event.client_payload.error.timestamp }}

          ## Stacktrace and Context

          ```json
          ${{ toJson(github.event.client_payload.error.stacktrace) }}
          ```

          ## Full Context

          ```json
          ${{ toJson(github.event.client_payload.error.context) }}
          ```

          ## Investigation Tasks

          Please perform the following:

          1. **Analyze the Error**:
             - Read the file mentioned in the culprit: `${{ github.event.client_payload.error.culprit }}`
             - Understand what caused the error
             - Check if this is a real bug or a test endpoint

          2. **Identify Root Cause**:
             - Determine why this error occurred
             - Check if it's a code issue, configuration issue, or intentional behavior
             - If it's the `/sentry-debug/` endpoint, this is intentional for testing

          3. **Implement Fix**:
             - If this is a real bug, implement a proper fix
             - If this is a test endpoint triggering false alerts, consider:
               a) Adding proper error handling
               b) Documenting it's for testing only
               c) Adding a flag to disable in production
             - Ensure the fix doesn't break existing functionality

          4. **Add Tests** (if applicable):
             - Write unit tests to prevent regression
             - Ensure existing tests still pass

          5. **Commit Changes**:
             - Make clear, descriptive commit messages
             - Reference error ID: ${{ github.event.client_payload.error.errorId }}

          ## Important Notes

          - This repository follows Django/Python best practices
          - Check `CLAUDE.md` for project-specific guidelines
          - Run tests before committing: `python manage.py test`
          - Follow PEP 8 style guidelines

          Please proceed with the investigation and fix. Commit your changes to this branch.
          EOF

          cat investigation_prompt.md

      - name: Run Claude Code Investigation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Starting Claude Code investigation..."

          # Run Claude Code with the investigation prompt
          claude-code --prompt "$(cat investigation_prompt.md)" \
            --auto-commit \
            --max-iterations 10 \
            2>&1 | tee claude_output.log || echo "Claude Code execution completed"

          echo "Claude Code investigation completed"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes were made by Claude Code"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status
            git diff --stat
          fi

      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create PR body with error details
          cat > pr_body.md << 'EOFPR'
          ## ðŸ¤– Automated Error Fix

          This PR was automatically created by Claude Code in response to a production error detected by BetterStack.

          ### Error Details

          - **Error ID**: ${{ github.event.client_payload.error.errorId }}
          - **Error Type**: `${{ github.event.client_payload.error.errorType }}`
          - **Message**: ${{ github.event.client_payload.error.message }}
          - **File**: `${{ github.event.client_payload.error.culprit }}`
          - **Application**: ${{ github.event.client_payload.error.projectName }}
          - **Environment**: ${{ github.event.client_payload.error.environment }}
          - **Timestamp**: ${{ github.event.client_payload.error.timestamp }}

          ### Stacktrace

          ```json
          ${{ toJson(github.event.client_payload.error.stacktrace) }}
          ```

          ### Changes Made

          Claude Code analyzed the error and implemented a fix. Please review the changes carefully before merging.

          ### Testing

          - [ ] Review the code changes
          - [ ] Run tests locally: `python manage.py test`
          - [ ] Verify the fix addresses the root cause
          - [ ] Check for any side effects

          ---

          ðŸ¤– **Automated PR created by Claude Code**
          ðŸ“Š **BetterStack Incident**: ${{ github.event.client_payload.error.errorId }}
          ðŸ”— **Source**: BetterStack Error Monitoring
          EOFPR

          # Create the pull request
          gh pr create \
            --title "ðŸ¤– Fix: ${{ github.event.client_payload.error.title }}" \
            --body-file pr_body.md \
            --base main \
            --head "$BRANCH_NAME" \
            --label "automated,bug,claude-code" \
            --assignee "${{ github.repository_owner }}"

          echo "âœ… Pull request created successfully"

      - name: Comment on failure
        if: failure()
        run: |
          echo "âŒ Claude Code investigation failed or encountered an error"
          echo "Check the logs above for details"

      - name: Cleanup
        if: always()
        run: |
          rm -f error_context.json investigation_prompt.md pr_body.md claude_output.log
