name: Claude Code Error Investigation

on:
  repository_dispatch:
    types: [error_investigation]

jobs:
  investigate:
    runs-on: ubuntu-latest
    name: Investigate Error with Claude Code
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display error information
        run: |
          echo "ðŸ” BetterStack Error Investigation Triggered"
          echo "============================================="
          echo "Error ID: ${{ github.event.client_payload.error.errorId }}"
          echo "Title: ${{ github.event.client_payload.error.title }}"
          echo "Error Type: ${{ github.event.client_payload.error.errorType }}"
          echo "Message: ${{ github.event.client_payload.error.message }}"
          echo "Platform: ${{ github.event.client_payload.error.platform }}"
          echo "Environment: ${{ github.event.client_payload.error.environment }}"
          echo "Project: ${{ github.event.client_payload.error.projectName }}"
          echo "Culprit: ${{ github.event.client_payload.error.culprit }}"
          echo "Timestamp: ${{ github.event.client_payload.error.timestamp }}"
          echo "Source: ${{ github.event.client_payload.source }}"
          echo "============================================="

      - name: Create error context file
        run: |
          cat > error_context.json << 'EOF'
          ${{ toJson(github.event.client_payload.error) }}
          EOF
          echo "Error context file created:"
          cat error_context.json | jq '.'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f development.txt ]; then pip install -r development.txt; fi

      - name: Create investigation issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create issue body with error details
          cat > issue_body.md << 'EOFISSUE'
          ## ðŸš¨ Production Error Detected

          An error was automatically detected by BetterStack monitoring and requires investigation.

          ### Error Details

          - **Error ID**: `${{ github.event.client_payload.error.errorId }}`
          - **Error Type**: `${{ github.event.client_payload.error.errorType }}`
          - **Message**: ${{ github.event.client_payload.error.message }}
          - **File/Function**: `${{ github.event.client_payload.error.culprit }}`
          - **Application**: ${{ github.event.client_payload.error.projectName }}
          - **Environment**: ${{ github.event.client_payload.error.environment }}
          - **Timestamp**: ${{ github.event.client_payload.error.timestamp }}

          ### Stacktrace

          ```json
          ${{ toJson(github.event.client_payload.error.stacktrace) }}
          ```

          ### Full Context

          ```json
          ${{ toJson(github.event.client_payload.error.context) }}
          ```

          ### Investigation Tasks

          - [ ] Analyze the error and its stacktrace
          - [ ] Identify the root cause
          - [ ] Determine if this is a real bug or expected behavior (e.g., test endpoint)
          - [ ] Implement a fix if needed
          - [ ] Add tests to prevent regression
          - [ ] Create a PR with the fix

          ### Notes

          - Check if `/sentry-debug/` - this is a test endpoint for error monitoring
          - Follow project guidelines in `CLAUDE.md`
          - Run tests: `python manage.py test`
          - Follow PEP 8 style guidelines

          ---

          ðŸ¤– **Automated issue created by BetterStack Error Monitoring**
          ðŸ“Š **Incident ID**: ${{ github.event.client_payload.error.errorId }}
          ðŸ”— **Source**: BetterStack via DigitalOcean Functions

          _Note: Once Claude Code CLI becomes available, this workflow will automatically investigate and create PRs with fixes._
          EOFISSUE

          # Check if issue already exists
          EXISTING_ISSUE=$(gh issue list \
            --label "betterstack,automated" \
            --search "${{ github.event.client_payload.error.errorId }}" \
            --json number \
            --jq '.[0].number' || echo "")

          if [ -z "$EXISTING_ISSUE" ]; then
            # Create the issue
            gh issue create \
              --title "ðŸ¤– Error: ${{ github.event.client_payload.error.title }}" \
              --body-file issue_body.md \
              --label "bug,betterstack,automated" \
              --assignee "${{ github.repository_owner }}"
            echo "âœ… New issue created for error ${{ github.event.client_payload.error.errorId }}"
          else
            echo "â„¹ï¸  Issue #$EXISTING_ISSUE already exists for this error"
            # Add comment to existing issue
            gh issue comment "$EXISTING_ISSUE" \
              --body "ðŸ”„ **Error occurred again**

          **Timestamp**: ${{ github.event.client_payload.error.timestamp }}
          **Environment**: ${{ github.event.client_payload.error.environment }}

          This error has been detected again. Please prioritize investigation."
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f error_context.json issue_body.md

      # TODO: Replace issue creation with Claude Code investigation when CLI becomes available
      # - name: Install Claude Code CLI
      #   run: |
      #     # Install Claude Code CLI (package name TBD)
      #     npm install -g @anthropic-ai/claude-code
      #
      # - name: Run Claude Code Investigation
      #   env:
      #     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      #   run: |
      #     # Create investigation branch
      #     git checkout -b "fix/error-${{ github.event.client_payload.error.errorId }}"
      #
      #     # Run Claude Code investigation
      #     claude-code investigate \
      #       --error-context error_context.json \
      #       --auto-commit \
      #       --create-pr
